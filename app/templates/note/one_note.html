{% extends 'base.html' %}

{% block title %}{{ this_note.title }} - 小熊笔记{% endblock %}

{% block header %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/typo.css') }}" />
<script src="{{ url_for('static', filename='js/commonmark.min.js') }}"></script>
{% endblock %}

{% block content %}
<div class="content">
    <div class="article">
        <div class="article-header">
            <div class="title">{{ this_note.title }}</div>
            {% if this_note.subtitle %}
            <div class="subtitle">{{ this_note.subtitle }}</div>
            {% endif %}
            <div class="information">
                {{ this_note.time.strftime('%Y-%m-%d') }}
                {% if 'user' in session %}
                {% if this_note.belong.email == session.user.email %}
                <span class="action"><a href="{{ url_for('note_module.note_edit_function',noteid=this_note.noteid) }}">修改</a> <a href="{{ url_for('note_module.note_delete_function',noteid=this_note.noteid) }}">删除</a></span>
                {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="article-content typo" id="article-content">{{ this_note.content }}</div>
        {% if this_note.public_status == 1 %}
        <div class="article-author">
            <h3>作者信息</h3>
            <img src="https://cdn.v2ex.com/gravatar/{{ this_note.belong.email_md5 }}?s=64&d=retro" class="article-author-gravator">
            <div class="article-author-information">
                <div class="article-author-author">{{ this_note.belong.username }}</div>
                <div class="article-author-email">{{ this_note.belong.email }}</div>
                {% if this_note.belong.description %}
                <div class="article-author-description">{{ this_note.belong.description }}</div>
                {% endif %}
            </div>
        </div>
        <div class="comment-list">
          <h3>评论列表</h3>
          {% for one_comment in all_comment %}
              <div class="one-comment">
                <div class="one-comment-img"><img src="https://cdn.v2ex.com/gravatar/{{one_comment.belong.email_md5}}?s=42&d=retro"></div>
                <div class="one-comment-content">
                  {{one_comment.content}}
                  <div class="one-comment-content-inf">{{one_comment.belong.username}} / {{one_comment.belong.email}} / {{ one_comment.time.strftime('%Y-%m-%d') }}</div>
                 </div>
                </div>
          {% endfor %}
        </div>
        <div class="comment-post">
            <h3>提交一条新评论 <span>{{ session['user']['username'] }}</span></h3>
            <form method="POST">
                {{ comment.csrf_token }}
                {{ comment.content(class="input comment",placeholder="评论内容") }}
                <button class="button">提交</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block jsruner %}

<script>

function html_decode(str)  
{  
  if (str.length == 0) return "";  
  str = str.replace(/&lt;/g, "<");  
  str = str.replace(/&gt;/g, ">");  
  str = str.replace(/&nbsp;/g, " ");  
  str = str.replace(/&#39;/g, "\'");  
  str = str.replace(/&quot;/g, "\"");  
  str = str.replace(/<br>/g, "\n");  
  return str;  
}
var article_content = document.getElementById("article-content");
var reader = new commonmark.Parser({safe:true});
var writer = new commonmark.HtmlRenderer({safe:true});
writer.softbreak = "<br />";
var parsed = reader.parse(html_decode(article_content.innerHTML)); // parsed is a 'Node' tree

var result = writer.render(parsed);
article_content.innerHTML = result;


</script>
{% endblock %}